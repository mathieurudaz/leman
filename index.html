<!DOCTYPE html>
<html>

<head>
    <title></title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Eczar" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Asul" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Francois+One" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Pathway+Gothic+One" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/header.css">
    <link rel="stylesheet" type="text/css" href="css/footer.css">
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/2.1.19/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/css/tooltipster.min.css" />
    <style type="text/css">
      body, html{
        -webkit-font-smoothing: antialiased;
        padding: 0px;
        margin: 0px;
        height: 100%;
        font-family: "Montserrat", sans-serif;
      }
      p a{
        color: inherit;
        text-decoration: underline;
      }
      a:active, a:hover, a:focus{
        color: inherit;
      }
      p{
        opacity: 0.85;
        font-size: 20px;
        line-height: 1.75;
        text-shadow: 0px 0px 4px rgba(255,255,255,0.6);
      }
      h2{
        font-family: "Pathway Gothic One", sans-serif;
        text-transform: uppercase;
        text-shadow: 0px 0px 4px rgba(255,255,255,0.6);
        opacity: 0.85;
        font-size: 30px;
      }
      canvas{
        position: fixed;
        top:0px;
        left: 0px;
      }
      .container_sp{
        position: relative;
        z-index: 1;
        min-height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffffff;
      }

      .footer{
        height: 90px;
        position: fixed;
        z-index: 2;
        bottom: 0px;
        left: 0px;
        width: 100%;
        color: white;
        font-family: "Pathway Gothic One", sans-serif;
        text-transform: uppercase;
        font-size: 20px;
        line-height: 1;
      }

      .footer > div{
        display: -webkit-flex;
        display: flex;
        -webkit-justify-content: center;
        justify-content: center;
        -webkit-flex-wrap: wrap;
        flex-wrap: wrap;
        -webkit-align-items: center;
        align-items: center;
      }

      .footer > div > div{
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: center;
            -ms-flex-pack: center;
                justify-content: center;
        -ms-flex-wrap: wrap;
            flex-wrap: wrap;
        -webkit-box-flex: 1;
            -ms-flex-positive: 1;
                flex-grow: 1;
        -webkit-box-align: center;
            -ms-flex-align: center;
                align-items: center;
      }

      .footer > div > div > div{
        -webkit-flex-grow: 1;
        flex-grow: 1;
      }

      .footer .pagination{
        font-size: 30px;
        line-height: 0px;
      }

      .footer .mdi-navigation{
        font-size: 8px;
      }

      .footer .mdi-navigation.down{
        transform: rotate(180deg);
      }

      .footer a{
        display: inline-block;
      }
      .footer a:active, .footer a:hover, .footer a:focus{
        text-decoration: none;
      }

      .menu-link{
        color: white;
      }

      .menu-link:hover{
        color: white;
        text-decoration: none;
      }

      #scene-1{
        height: 200vh;
      }

      .map_scene{
        position: absolute;
        z-index: 99;
        top:0px;
        left: 0px;
        width: 100%;
        width: height%;
        color: rgba(255,255,255,0.65);
        display: none;
      }

      .map-infos{
        border-top:1px solid rgba(255,255,255,0.2);
        margin-top: 70px;
      }

    </style>
</head>

<body>

      <nav class="navbar navbar-default navbar-fixed-top navfade">
        <div class="container">
          <div class="row">
            <div class="col-md-6">
              <div class="navbar-header">
                  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                      <span class="sr-only">Toggle navigation</span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                  </button>
                  <a class="navbar-brand" href="https://www.24heures.ch">
                  </a>
              </div>
            </div>
            <div class="col-md-6">
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                  <ul class="nav navbar-nav navbar-right">
                      <li><a onclick="window.open(this.href, '_blank', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false" href="https://www.facebook.com/sharer/sharer.php?u=http%3A//www.24heures.ch/extern/interactive_wch/insectes"><i class="mdi mdi-facebook"></i></a></li>
                      <li><a onclick="window.open(this.href, '_blank', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false" href="http://twitter.com/intent/tweet?text=A vos insectes, prêts, dégustez! http://insectes.24heures.ch"><i class="mdi mdi-twitter"></i></a></li>
                      <li><a href="mailto:?&amp;subject=24heures - A vos insectes, prêts, dégustez!&amp;body=Dès le 1er mai, les Suisses pourront légalement acheter et consommer trois insectes différents. Zoom dans nos assiettes. http://insectes.24heures.ch"><i class="mdi mdi-email"></i></a></li>
                  </ul>
              </div>
            </div>
          </div>
        </div>
    </nav>

    <div id="scene-1" class="container container_sp" style="margin-top: 100vh;">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
        </div>
      </div>
    </div>

    <div id="scene-2" class="container container_sp"></div>

    <div id="scene-3" class="container container_sp">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <p>Le 24 novembre 1883, la Feuille d’Avis de Lausanne noircit ses colonnes avec le récit d’un triste naufrage survenu la veille. Par une nuit de tempête où le vent soulève des vagues énormes, deux navires à vapeurs, le Cygne et le Rhône, ayant chacun dévié de leur route habituelle, entrent en collision. Le premier parvient, non sans difficulté, à rejoindre le port, mais le second, trop amoché, sombre dans les abysses lémaniques, emportant avec lui onze passagers et trois membres d’équipage. Dernier vestige du drame, son épave repose aujourd’hui par 300 mètres de profondeur.</p>
          <p>Cet accident est l’un des nombreux drames au coeur de l’exposition “Fantômes du Léman”, une exposition itinérante qui, après les Bains des Pâquis à Genève jusqu’au 13 mai, fera escale cet été à Saint-Gingolph avant de caboter d’une localité lémanique à l’autre en 2019. “Quand les gens se baignent ou naviguent sur le Léman, ils n’ont pas conscience de tout ce qu’il recèle”, raconte Philippe Constantin, coordinateur de l’Association d’usagers des Bains des Pâquis (AUBP), à l’origine du projet avec son collègue, Michel-Félix de Vidas, responsable du groupe d’animation culturelle de l’AUBP. Avant de continuer: “C’est pourquoi on a eu l’idée d’enquêter sur les mystères de notre lac, de faire remonter quelques fantômes à la surface et de monter cette exposition.”</p>
        </div>
      </div>
    </div>

    <div id="scene-3b" class="container container_sp"></div>

    <div id="scene-3c" class="container container_sp">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <p>Derrière ses airs lisses et romantique, le Léman cache <a href="#">bien des histoires méconnues</a> et oubliées aux conclusions parfois heureuses et cocasses mais également funestes. Des naufrages de bateaux piégés dans les tourbillons d’un lac déchaîné, au crash d’un hydravion pris dans une tempête soudaine, en passant par l’amerrissage forcé d’une montgolfière mise à mal par la bise, ou encore la présence mystérieuse de quatre wagons dormant à plus de 300 mètres de profondeur entre Ouchy et Lutry. “Le Léman peut être un lac très calme. Mais ce n’est pas un étang pour autant, relève Lionel Gauthier, conservateur du Musée du Léman à Nyon. Il peut parfois s’énerver et se montrer impitoyable.” Comme en août 1969, date de l’une des dernières grosses tragédie que le lac a connu, lorsque le bateau de plaisance la Fraidieu, surpris par la bise, avait fait naufrage au large de Thonon (F). Un drame au bilan particulièrement sévère puisqu’il a fait 24 morts, dont 14 petites orphelines d’une colonie de vacances qui ne savaient pas nager.</p>
        </div>
      </div>
    </div>

    <div id="scene-4" class="container container_sp"></div>

    <div id="scene-5" class="container container_sp">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <h2>Une mer intérieure?</h2>
          <p>La bise, le Bornan, le Joran, le Vaudaire… Il faut dire que, enchâssé entre les Alpes et le Jura, le Léman est balayé par une dizaine de vents différents évoluant au gré des saisons, mais aussi des heures de la journée. Des airs lémaniques rendant parfois sa traversée périlleuse. Même Eric Tabarly, célèbre navigateur français venu participé au Bol d’Or en 1991, l’avait convenu: “On m’avait dit qu’il était traître, mais je n’aurais jamais cru à ce point.” Certains n’hésitant d’ailleurs pas à le surnommer “La Petite mer des Alpes”.</p>
          <p>“Je ne sais pas si on peut aller jusqu’à le comparer à une mer intérieure, relève Frédéric Glassey de Météonews. Mais une chose est sûre: le bassin lémanique est constituée d’une vaste étendue d’eau entourée de reliefs, vecteurs d’orages pouvant être localement violent.” Des coups de tabac soudains et difficiles à prévoir que redoutent les navigateurs.</p>
        </div>
      </div>
    </div>

    <div id="scene-6" class="container container_sp"></div>

    <div id="scene-7" class="container container_sp">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <h2>Des erreurs humaines</h2>
          <p>Mais Dame nature n’est pas seule responsable. Le fourvoiement des hommes est également à l’origine de nombreux drames. A l’instar du naufrage de l’Hirondelle le 10 juin 1862 au large de la Tour-de-Peilz, après que sa coque a touché, dans une manoeuvre maladroite, le fond rocheux, peu profonds à cet endroit-là. Si ses quelques 300 passagers ont pu tous être secourus, l’élégant navire à vapeur repose aujourd’hui à près de 60 mètres sous la surface.</p>
          <p>Des accidents spectaculaires comme celui-ci sont de moins en moins fréquents sur le Léman. Motorisation des bateaux, moyens de communication plus efficaces, images satellite permettant de mieux prédire la météo, radars: depuis une cinquantaine d’années, le domaine de la navigation a connu une véritable révolution. “Il y a encore pas si longtemps, avant l’apparition de la radio, c’est à la fusée que les secours étaient appelés. Et ensuite, c’était à la rame que ces derniers intervenaient”, rappelle alors Michel Detrey, président de la Société internationale de sauvetage du Léman (SISL), dont toutes les sections régionales confondues sont intervenues près de 820 fois en 2017. “Aujourd’hui, quand on doit intervenir, on peut être au milieu de lac en moins 20 minutes. Et c’est généralement pour de petites pannes ou du premier secours. Mais plus pour des naufrages ou des grosses casses comme à l’époque.”</p>
          <p>Sans compter qu’au fil des années et des tragédies, les règles de sécurité n’ont eu de cesse de s’affiner.  “A chaque fois, on a tiré des enseignements de ces événements, ce qui a aussi permis d’améliorer la sécurité sur le lac”, souligne Michel Detrey. A noter d’ailleurs que c’est après la dramatique collision du Rhône et du Cygne que la nécessité de structurer et de mutualiser le sauvetage sur le lac est apparue. D’où la création, le 6 juin 1885, de la SISL regroupant aujourd’hui 34 sections locales réparties entre le Valais, Vaud, Genève et la France. Cette vaste communauté de riverains se moquant des frontières est le témoin vivant d’une histoire et d’une solidarité nées du lac.</p>
        </div>
      </div>
    </div>

    <div id="scene-8" class="container container_sp"></div>

    <div id="scene-9" class="container container_sp">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <h2>L’importance du travail de mémoire</h2>
          <p>Il y a des stèles commémoratives posées ça et là tout autour du lac en mémoire de certains naufrages. Il y a des articles de presse qui paraissent parfois lorsque c’est l’anniversaire d’un drame particulièrement marquant. Et il y a des passionnés qui montent ponctuellement des expositions sur l’un ou l’autre aspect de l’histoire lémanique, à l’instar de Philippe Constantin et Michel-Félix de Vidas de l’Association des usagers des Bains des Pâquis (AUBP) à Genève qui ont monté les “Fantômes du lac” attendu dans plusieurs localités du pourtour lémanique, dont Saint-Gingolph cet été.</p>
          <p>“Chaque catastrophe n’a pas son épave au fond du lac. Et les témoins ou rescapés ne sont souvent plus là pour nous en parler. D’où l’importance du travail de mémoire pour rappeler aux gens que notre lac peut être impitoyable.” Toutes ces initiatives enchantent Lionel Gauthier, conservateur du Musée du Léman à Nyon. Surtout que, malgré des projets d’agrandissement, le musée du Léman ne serait jamais être assez grand pour tout dire et tout montrer.</p>
        </div>
      </div>
    </div>

    <div class="map_scene">
      <div class="map-infos container fluid">Infos</div>
      <div class="map-tooltip">Tooltip</div>
    </div>

    <div class="footer">
      <div class="container">
        <div class="row">
          <div class="col-xs-5 text-left">
            <a class="menu-link" id="map-link" href="#">La carte des événements</a>
          </div>
          <div class="col-xs-2 text-center">
            <div class="mdi mdi-navigation up"></div>
            <div class="pagination">1</div>
            <div class="mdi mdi-navigation down"></div>
          </div>
          <div class="col-xs-5 text-right">En savoir plus</div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.4/TweenMax.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.4/TimelineMax.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.0/pixi.min.js"></script>
    <script src="node_modules/pixi-filters/dist/pixi-filters.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.5/ScrollMagic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.5/plugins/debug.addIndicators.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tilt.js/1.2.1/tilt.jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/js/jquery.tooltipster.min.js"></script>
    <script type="text/javascript">
      var displacementSprite
      var displacementFilter 
      var displacementTextSprite 
      var displacementTextFilter
      var transitionActive = false;
      var depthTranstionActive = false;
      var sceneId = 0;
      var background, introContainer
      var blurFilter = new PIXI.filters.BlurFilter();
      var noiseFilter = new PIXI.filters.NoiseFilter();
      var colorMatrix = new PIXI.filters.ColorMatrixFilter();
      var motionBlur = new PIXI.filters.MotionBlurFilter();
      var testBlur = new PIXI.filters.TiltShiftFilter();
      var title
      var depth
      var app
      var scenes, sceneSprites, introVideoSprite
      var pointerMask, pointerMaskTexture, pointerMaskSprite
      var parallaxOffset = 0
      var introPaper
      var introPaperXOffset = introPaperYOffset = 0

      function Scene(id, background){
        this.id = id;
        this.container = new PIXI.Container();
      }

      var titles = [
        "Les fantômes du Léman",
        "le Rhône",
        "le Brick",
        "La Carte"
      ]

      $(document).ready(function(){

      var width = $(window).width();
      var height = $(window).height();

      textWidth = 400
      if(width < 768){
        textWidth = 300
      }else if(width < 1280 ){
        textWidth = 400
      }else{
        textWidth = 400
      }

      var video = document.createElement("video");
      video.preload = "auto";
      video.muted = true;
      video.loop = true;
      video.src = "./scenes/intro.mp4";

      app = new PIXI.Application({
          width: width,
          height: height,
          antialias: true,
          transparent: false,
          resolution: 1,
          autoresize: true
      });

      background = new PIXI.Container();
      introContainer = new PIXI.Container();

      //app.renderer.resize(width, height)
      app.stage.addChild(background);
      
      background.scale.x = 1;
      background.scale.y = 1;

      introContainer.scale.x = 1;
      introContainer.scale.y = 1;
      introContainer.x = 0;
      introContainer.y = (app.screen.height+100) + 9000;

      // create a video texture from a path
      introVideoSprite = new PIXI.Sprite(PIXI.Texture.fromVideo(video));

      scenes = {
        "intro": new Scene(),
        "transition": new PIXI.Container(),
        "map": new PIXI.Container(),
        "brick": new PIXI.Container(),
        "rhone": new PIXI.Container(),
        "hirondelle": new PIXI.Container(),
        "nemo": new PIXI.Container(),
        "wagons": new PIXI.Container()
      }

      sceneSprites = [
        new PIXI.Sprite(PIXI.Texture.fromImage("./scenes/intro_deep.jpg")),
        new PIXI.Sprite(PIXI.Texture.fromImage("./scenes/wreck_1.jpg")),
        new PIXI.Sprite(PIXI.Texture.fromImage("./scenes/wreck_2.jpg")),
        new PIXI.Sprite(PIXI.Texture.fromImage("./scenes/wreck_3.jpg")),
        new PIXI.Sprite(PIXI.Texture.fromImage("./scenes/wreck_4.jpg")),
        new PIXI.Sprite(PIXI.Texture.fromImage("./scenes/wreck_5.jpg"))
      ]

      //Create the intro image and text
      var introVideo = new PIXI.Sprite(PIXI.Texture.fromImage("./video_intro.jpg"));
      introVideo.x = app.screen.width/2 - 300;
      introVideo.y = app.screen.height/2;
      introVideo.pivot.x = introVideo.width * 0.5;
      introVideo.pivot.y = introVideo.height * 0.5;
      introVideo.interactive = true;
      introVideo.buttonMode = true;
      introVideo.defaultCursor = 'pointer';

      var introText = new PIXI.Text("Donec rhoncus suscipit arcu, vel vehicula elit bibendum vitae. Phasellus posuere semper odio, a tristique velit dignissim eu. Curabitur vel odio diam. Quisque vitae odio sit amet tortor luctus vestibulum. Pellentesque quis porttitor dolor.",
          {
              fontFamily: 'Montserrat',
              fontSize: 20,
              fontWeight: "300",
              letterSpacing: 0,
              fill: 0xffffff,
              align: 'center',
              lineHeight: 25,
              padding: 30,
              wordWrap: true,
              wordWrapWidth: textWidth
          });
      introText.anchor.x = 0.5;
      introText.anchor.y = 0.5;
      introText.x = app.screen.width/2;
      introText.y = app.screen.height/2 + 200;
      //introVideo.filters = [new PIXI.filters.BlurFilter(0.5)];

      introContainer.addChild(introVideo)
      //introContainer.addChild(introText)

      // Intro newspaper
      introPaper = new PIXI.Sprite(PIXI.Texture.fromImage("./press.png"));
      introPaperXOffset = app.screen.width/2 - 150;
      introPaperYOffset = app.screen.height + 100;
      introPaper.pivot.x = introPaper.width * 0.5;
      introPaper.pivot.y = introPaper.height * 0.5;

      // Create the map background
      mapBackground = new PIXI.Sprite(PIXI.Texture.fromImage("./scenes/wreck_4.jpg"))
      mapBackground.width = app.screen.width + 200;
      mapBackground.height = app.screen.height + 200;
      mapBackground.x = -100;
      mapBackground.y = -100;
      scenes.map.addChild(mapBackground)

      // Create the map Sprite base
      var mapSprite = new PIXI.Sprite(PIXI.Texture.fromImage("./map_background.jpg"))
      scenes.map.addChild(mapSprite);

      // Create the map Sprite hover effect
      var mapSpritePointer = new PIXI.Sprite(PIXI.Texture.fromImage("./map_pointer_texture.jpg"))
      mapSpritePointer.width = app.screen.width + 200;
      mapSpritePointer.height = app.screen.height + 200;
      mapSpritePointer.x = -100;
      mapSpritePointer.y = -100;
      //scenes.map.addChild(mapSpritePointer);

      pointerMask = new PIXI.Sprite(PIXI.Texture.fromImage("./pointer_mask.jpg"))
      pointerMask.anchor.set(0.5)
      pointerMask.x = 200;
      pointerMask.y = 200;
      scenes.map.addChild(pointerMask);

      // Create the map polygon
      var map = new PIXI.Graphics()

      // Create the map container
      var mapContainer = new PIXI.Container();


      var projection = d3.geoMercator();
      var lemanBounds = [
        [6.083, 46.200], // SW
        [7.013, 46.552] // NE
      ]
      
      var mapWidth = app.view.width
      var mapHeight = app.view.height

      map.width = mapWidth;
      map.height = mapHeight;
      map.x = 0;
      map.y = 0; //app.view.height/2 - mapHeight/2;
      map.pivot.x = map.width/2
      map.pivot.y = map.height/2
      map.scale.x = 1
      map.scale.y = 1

      /*map.beginFill(0xff00ff, 1);
      map.drawRect(0, 0, mapWidth, mapHeight);
      map.endFill();*/

      projection
          .scale(1)
          .translate([0, 0]);

      var b = [
            projection(lemanBounds[0]), 
            projection(lemanBounds[1])],
          s = 1 / Math.max(
            (b[1][0] - b[0][0]) / mapWidth,
            (b[1][1] - b[0][1]) / mapHeight),
          t = [
            (mapWidth  - s * (b[1][0] + b[0][0])) / 2, 
            (mapHeight - s * (b[1][1] + b[0][1])) / 2
          ];

      projection
          .scale(s)
          .translate(t);

      var path = d3.geoPath()
         .projection(projection)
         .context(map);

      d3.json("leman.topojson", function(error, leman) {
        if (error) throw error;
        map.beginFill(0xffffff, 0.2);
        path(topojson.mesh(leman));
        map.endFill();

        // Mask the lake base texture with the polygon of the lake
        mapSprite.mask = map;
        //pointerMask.mask = map;

        // Mask the pointer layer with the pointer mask
        mapSpritePointer.mask = pointerMask;

        pointerMaskTexture = new PIXI.Texture(
          app.renderer.generateTexture(mapSpritePointer));

        pointerMaskSprite = new PIXI.Sprite(pointerMaskTexture);

        scenes.map.addChild(pointerMaskSprite);
        //map.blendMode = PIXI.BLEND_MODES.DIFFERENCE;


        var pointBlur = new PIXI.filters.BlurFilter();
        pointBlur.blur = 2

        var point = new PIXI.Graphics();
        point.beginFill(0xffffff, 1);
        point.drawCircle(0, 0, 10);
        point.endFill();

        d3.json("incidents.geojson", function(error, incidents) {
          for(var i=0; i<incidents.features.length; i++){
            let p = incidents.features[i].geometry.coordinates
            let pointTexture = new PIXI.Texture(app.renderer.generateTexture(point));
            let pointSprite = new PIXI.Sprite(pointTexture);

            //console.log(incidents.features[i])

            pointSprite.x = projection([p[0], p[1]])[0]
            pointSprite.y = projection([p[0], p[1]])[1]
            pointSprite.interactive = true
            pointSprite.buttonMode = true
            pointSprite.defaultCursor = 'pointer';
            pointSprite.anchor.set(0.5)
            pointSprite.filters = [pointBlur];
            pointSprite.alpha = 0.75;
            pointSprite.blendMode = PIXI.BLEND_MODES.ADD;

            pointSprite.pointerover = function(f) {
              return function(){
                console.log(f)
                this.alpha = 0.65;
                this.scale.set(2, 2)
                $(".map-tooltip").text(f.properties["Name"])
              }
            }(incidents.features[i])

            pointSprite.pointerout = function(mouseData) {
              this.alpha = 0.75;
              this.scale.set(1, 1)
            }

            mapContainer.addChild(pointSprite)
          }
        })
      });

      mapContainer.addChild(map)
      scenes.map.addChild(mapContainer)

      // Intro video
      introVideoSprite.width = app.screen.width + 200;
      introVideoSprite.height = app.screen.height + 200;
      introVideoSprite.x = -100;
      introVideoSprite.y = -100;

      // Dive
      sceneSprites[0].width = app.screen.width + 200;
      sceneSprites[0].height = 9000;
      sceneSprites[0].x = -100;
      sceneSprites[0].y = app.screen.height + 100;

      // Rhône
      sceneSprites[1].width = app.screen.width + 200;
      sceneSprites[1].height = app.screen.height + 200;
      sceneSprites[1].x = -100;
      sceneSprites[1].y = (app.screen.height+100) + 9000;

      // Machin
      sceneSprites[2].width = app.screen.width + 200;
      sceneSprites[2].height = app.screen.height + 200;
      sceneSprites[2].x = -100;
      sceneSprites[2].y = (app.screen.height+100) + 9000;

      // Truc
      sceneSprites[3].width = app.screen.width + 200;
      sceneSprites[3].height = app.screen.height + 200;
      sceneSprites[3].x = -100;
      sceneSprites[3].y = (app.screen.height+100) + 9000;

      sceneSprites[4].width = app.screen.width + 200;
      sceneSprites[4].height = app.screen.height + 200;
      sceneSprites[4].x = -100;
      sceneSprites[4].y = (app.screen.height+100) + 9000;

      sceneSprites[5].width = app.screen.width + 200;
      sceneSprites[5].height = app.screen.height + 200;
      sceneSprites[5].x = -100;
      sceneSprites[5].y = (app.screen.height+100) + 9000;

      blurFilter = new PIXI.filters.BlurFilter();
      noiseFilter = new PIXI.filters.NoiseFilter();
      colorMatrix = new PIXI.filters.ColorMatrixFilter();
      motionBlur = new PIXI.filters.MotionBlurFilter();
      motionBlur.velocity = [300, 100] 
      blurFilter.blur = 1;
      noiseFilter.noise = 0.075;
      colorMatrix.contrast(0.5);

      displacementSprite = PIXI.Sprite.fromImage('displace.png');
      displacementFilter = new PIXI.filters.DisplacementFilter(displacementSprite);
      displacementTextSprite = PIXI.Sprite.fromImage('displace.png');
      displacementTextFilter = new PIXI.filters.DisplacementFilter(displacementTextSprite);

      displacementFilter.map.baseTexture.wrapMode = PIXI.WRAP_MODES.REPEAT;

      app.stage.addChild(displacementSprite);
      app.stage.addChild(displacementTextSprite);

      background.filters = [displacementFilter, noiseFilter];
      introPaper.filters = [displacementTextFilter, noiseFilter]
      map.filters = [blurFilter];

      title = createTitle()
      text = createText()

      background.addChild(sceneSprites[0])
      background.addChild(sceneSprites[5])
      background.addChild(sceneSprites[4])
      background.addChild(sceneSprites[3])
      background.addChild(sceneSprites[2])
      background.addChild(sceneSprites[1])
      background.addChild(introVideoSprite)
      //background.addChild(map)
      //background.addChild(introVideo);
      app.stage.addChild(title);
      scenes.map.x = 0;
      scenes.map.y = 0;
      scenes.map.filters = [noiseFilter, displacementTextFilter]
      //app.stage.addChild(scenes.map)

      var v = 0

      app.ticker.add(function(delta) {
            v += 0.1
            var mouseposition = app.renderer.plugins.interaction.mouse.global;

            if(mouseposition.x >= 0 && mouseposition.x <= app.screen.width
              && mouseposition.y >= 0 && mouseposition.y <= app.screen.height){
              sceneParallaxIt(mouseposition, background, -150);
              parallaxIt(mouseposition, title, -50);
              parallaxIt(mouseposition, mapContainer, -50);
            }

            // Floating movement based on combined sine waves
            introPaper.y =
            - (Math.sin(v*0.1)*Math.sin(v*0.2)*50) + introPaperYOffset
            introPaper.x =
            - (Math.sin(v*0.15)*Math.sin(v*0.3)*50)  + introPaperXOffset
            introPaper.skew.x =  Math.sin(v*0.1)*Math.sin(v*0.2)/10
            introPaper.skew.y =  Math.sin(v*0.15)*Math.sin(v*0.3)/10

            introVideo.y = - (Math.sin(v*0.1)*Math.sin(v*0.2)*50) + app.screen.height/2
            introVideo.x = - (Math.sin(v*0.15)*Math.sin(v*0.3)*50) + app.screen.width/2 - introVideo.width/2
            introVideo.skew.x =  Math.sin(v*0.1)*Math.sin(v*0.2)/10
            introVideo.skew.y =  Math.sin(v*0.15)*Math.sin(v*0.3)/10

            // Test
            /*TweenMax.to(container, 1, {
              rotation: 1
            });*/


            //Mask pointer for the map
            pointerMask.x = mouseposition.x
            pointerMask.y = mouseposition.y

            //pointerMaskTexture = new PIXI.Texture(
            //  app.renderer.generateTexture(mapSpritePointer));
            //pointerMaskSprite = new PIXI.Sprite(pointerMaskTexture);

            // Filters animation
            noiseFilter.seed = Math.random()
            displacementSprite.x += 5;
            displacementSprite.y += 5;
            displacementTextSprite.x += 2;
            displacementTextSprite.y += 2;
      });

      document.body.appendChild(app.view);

      });

      function createText(){

          var text = new PIXI.Text("Le 24 novembre 1883, la Feuille d’Avis de Lausanne noircit ses colonnes avec le récit d’un triste naufrage survenu la veille. Par une nuit de tempête où le vent soulève des vagues énormes, deux vapeurs, le Cygne et le Rhône, ayant chacun dévié de leur route habituelle, entrent en collision. Le premier parvient, non sans difficulté, à rejoindre le port, mais le second, trop amoché, sombre dans les abysses lémaniques, emportant avec lui onze passagers et trois membres d’équipage.",
          {
              fontFamily: 'Montserrat',
              fontSize: 20,
              fontWeight: "400",
              letterSpacing: 0,
              fill: "white",
              align: 'left',
              lineHeight: 25,
              padding: 30,
              wordWrap: true,
              wordWrapWidth: textWidth
          });
          text.anchor.x = 0.5;
          text.anchor.y = 0.5;
          text.x = app.screen.width/2;
          text.y = app.screen.height/2;
          return text;
      }

      function createTitle(text){
          var buttonEndTurn = new PIXI.Graphics();
          var buttonText = new PIXI.Text(titles[sceneId].toUpperCase(),
          {
              fontFamily: 'Pathway Gothic One',
              fontSize: "5.5vw",
              fontWeight: "400",
              letterSpacing: 6,
              fill: "white",
              align: 'center',
              lineHeight: 2,
              padding: 30
          });
          buttonText.anchor.x = 0.5;
          buttonText.anchor.y = 0.5;
          buttonText.alpha = 0.75
          buttonText.x = app.screen.width/2;
          buttonText.y = app.screen.height/2;
          buttonEndTurn.addChild(buttonText);
          return buttonEndTurn;
      }

      function createWreckTitle(title, date){
        var buttonEndTurn = new PIXI.Graphics();
        var buttonText = new PIXI.Text(title.toUpperCase(),
        {
            fontFamily: 'Pathway Gothic One',
            fontSize: "5vw",
            fontWeight: "400",
            letterSpacing: 6,
            fill: "white",
            align: 'center',
            lineHeight: 2,
            padding: 30
        });

        var dateText = new PIXI.Text(date.toUpperCase(),
        {
            fontFamily: 'Pathway Gothic One',
            fontSize: "2.5vw",
            fontWeight: "200",
            letterSpacing: 6,
            fill: "white",
            align: 'center',
            lineHeight: 2,
            padding: 30
        });

        buttonText.anchor.x = 0.5;
        buttonText.anchor.y = 0.5;
        buttonText.x = app.screen.width/2;
        buttonText.y = app.screen.height/2;

        dateText.anchor.x = 0.5;
        dateText.anchor.y = 0.5;
        dateText.x = app.screen.width/2;
        dateText.y = app.screen.height/2 + 40;

        buttonEndTurn.addChild(buttonText);
        buttonEndTurn.addChild(dateText);

        return buttonEndTurn;
    }

      function sceneParallaxIt(e, target, movement) {
        var $this = $(app.view);
        var relX = e.x - 0;
        var relY = e.y - 0;

        if( !transitionActive ){
          TweenMax.to(target, 1, {
            x: (relX - $this.width() / 2) / $this.width() * movement,
            y: (relY - $this.height() / 2) / $this.height() * movement - parallaxOffset
          });
        }
      }

      function parallaxIt(e, target, movement) {
        var $this = $(app.view);
        var relX = e.x - 0;
        var relY = e.y - 0;

        if( !transitionActive ){
          TweenMax.to(target, 1, {
            x: (relX - $this.width() / 2) / $this.width() * movement,
            y: (relY - $this.height() / 2) / $this.height() * movement
          });
        }
      }

      // Initialize ScrollMagic
      var scrollController = new ScrollMagic.Controller();
       
      // Create Scene #1 (Scroll to dive and newspaper apparition)
      new ScrollMagic.Scene({
          triggerElement: "#scene-1",
          triggerHook: 0.99,
          duration: $("#scene-1").height()
      })
        .on("progress", function(e){
          //depth.setText(Math.round(e.progress*300) + "M");
          introPaperYOffset = app.screen.height - (e.progress * 1000)
        })
        .on("enter", function(){
          sceneId = 1;
          transitionActive = true;

        /*depth = new PIXI.Text(5 + "m", {
            fontFamily: 'Pathway Gothic One',
            fontSize: "5vw",
            fontWeight: "400",
            letterSpacing: 6,
            fill: "white",
            align: 'center',
            lineHeight: 2,
            padding: 30
        });
        depth.anchor.x = 0.5;
        depth.anchor.y = 0.5;
        depth.x = app.screen.width/2;
        depth.y = app.screen.height/2;*/

        // Fade out the title
        TweenMax.to(title, 0.5, {alpha:0,
          onComplete: function(){
            app.stage.removeChild(title)
            //depth.alpha = 0;
            app.stage.addChild(introPaper)
            //app.stage.addChild(depth)
            //depth.filters = [displacementTextFilter];
            //TweenMax.to(depth, 1, {alpha:1})
          }})

        // Move the background
        TweenMax.to(background, 1, {
          ease: Circ.easeOut,
          y: -sceneSprites[0].height/2,
          onComplete: function(){
            parallaxOffset =  sceneSprites[0].height/2
            transitionActive = false;
            background.filters = [displacementFilter, noiseFilter];
          }
        });

      })
      .addIndicators({name: "Dive", colorTrigger:"#ff00ff", colorStart:"#ff00ff"})
      .addTo(scrollController);

      // Create scene #2 (Rhône)
      new ScrollMagic.Scene({
          triggerElement: "#scene-2",
          triggerHook: 0.99
      })
      .on("enter", function(){
        sceneId = 2;
        transitionActive = true;

        // Fade out the depth counter
        /*TweenMax.to(depth, 0.75, {alpha:0,
          onComplete: function(){
            app.stage.removeChild(depth)
          }})*/

        TweenMax.to(introPaper, 0.75, {alpha:0,
          onComplete: function(){
            app.stage.removeChild(introPaper)
          }})

        // Move the background
        TweenMax.to(background, 1, {
          ease: Circ.easeOut,
          y: -sceneSprites[0].height -introVideoSprite.height,
          onComplete: function(){
            console.log("animation complete")
            parallaxOffset =  sceneSprites[0].height + introVideoSprite.height
            transitionActive = false;
            background.filters = [displacementFilter, noiseFilter];
            title = createWreckTitle("Le Rhône", "23 novembre 1883")
            title.alpha = 0;
            app.stage.addChild(title)
            title.filters = [displacementTextFilter];
            TweenMax.to(title, 1, {alpha:0.75})
          }
        });

      })
      .addIndicators({name: "Rhône", colorTrigger:"#ffff00", colorStart:"#ffff00"})
      .addTo(scrollController);

      // Create scene #3 (Text)
      new ScrollMagic.Scene({
          triggerElement: "#scene-3",
          triggerHook: 0.75
      })
      .on("enter", function(){
        // Fade out the title
        TweenMax.to(title, 0.75, {alpha:0,
          onComplete: function(){
            app.stage.removeChild(title)
          }})

        // TODO: Add blur filter

      })
      .addIndicators({name: "Text", colorTrigger:"#00ffff", colorStart:"#00ffff"})
      .addTo(scrollController);

      // Create scene #3b (Video)
      new ScrollMagic.Scene({
          triggerElement: "#scene-3b",
          triggerHook: 0.25
      })
      .on("enter", function(){
        transitionActive = true;
        console.log("Show video")
        introContainer.alpha = 0;
        background.addChild(introContainer)
        TweenMax.to(introContainer, 0.75, {alpha:1})
      })
      .addIndicators({name: "Video", colorTrigger:"#ffff00", colorStart:"#ffff00"})
      .addTo(scrollController);

      // Create scene #3c (Text)
      new ScrollMagic.Scene({
          triggerElement: "#scene-3c",
          triggerHook: 0.75
      })
      .on("enter", function(){
        // Fade out the title
        TweenMax.to(introContainer, 0.75, {alpha:0,
          onComplete: function(){
            background.removeChild(introContainer)
          }})

        // TODO: Add blur filter

      })
      .addIndicators({name: "Text", colorTrigger:"#00ffff", colorStart:"#00ffff"})
      .addTo(scrollController);

      // Create scene #4 (Hirondelle)
      new ScrollMagic.Scene({
          triggerElement: "#scene-4",
          triggerHook: 0.25
      })
      .on("enter", function(){
        sceneId = 2;
        transitionActive = true;

        console.log("Fade and blur the scene.")

        sceneSprites[1].filters = [motionBlur]

        // Move the background
        TweenMax.to(sceneSprites[1], 2, {
          ease: Circ.easeOut,
          x: -app.screen.width,
          alpha: 0,
          onComplete: function(){
            console.log("animation complete")
            //parallaxOffset =  sceneSprites[0].height + introVideoSprite.height + sceneSprites[1].height
            parallaxOffset =  sceneSprites[0].height + introVideoSprite.height
            transitionActive = false;
            background.filters = [displacementFilter, noiseFilter];
            title = createWreckTitle("L'Hirondelle", "23 novembre 1883")
            title.alpha = 0;
            app.stage.addChild(title)
            title.filters = [displacementTextFilter];
            TweenMax.to(title, 1, {alpha:0.75})
          }
        });
      })
      .addIndicators({name: "Hirondelle", colorTrigger:"#ffff00", colorStart:"#ffff00"})
      .addTo(scrollController);

      // Create scene #5 (Text)
      new ScrollMagic.Scene({
          triggerElement: "#scene-5",
          triggerHook: 0.75
      })
      .on("enter", function(){
        // Fade out the title
        TweenMax.to(title, 0.75, {alpha:0,
          onComplete: function(){
            app.stage.removeChild(title)
          }})

        // TODO: Add blur filter

      })
      .addIndicators({name: "Text", colorTrigger:"#00ffff", colorStart:"#00ffff"})
      .addTo(scrollController);

      // Create scene #6 (Wagons)
      new ScrollMagic.Scene({
          triggerElement: "#scene-6",
          triggerHook: 0.25
      })
      .on("enter", function(){
        sceneId = 2;
        transitionActive = true;

        // Move the background
        TweenMax.to(sceneSprites[2], 2, {
          ease: Circ.easeOut,
          x: -app.screen.width,
          alpha: 0,
          onComplete: function(){
            console.log("animation complete")
            //parallaxOffset =  sceneSprites[0].height + introVideoSprite.height + sceneSprites[1].height + sceneSprites[2].height
            parallaxOffset =  sceneSprites[0].height + introVideoSprite.height
            transitionActive = false;
            background.filters = [displacementFilter, noiseFilter];
            title = createWreckTitle("Les Wagons", "23 novembre 1883")
            title.alpha = 0;
            app.stage.addChild(title)
            title.filters = [displacementTextFilter];
            TweenMax.to(title, 1, {alpha:0.75})
          }
        });
      })
      .addIndicators({name: "Wagons", colorTrigger:"#ffff00", colorStart:"#ffff00"})
      .addTo(scrollController);

      // Create scene #7 (Text)
      new ScrollMagic.Scene({
          triggerElement: "#scene-7",
          triggerHook: 0.75
      })
      .on("enter", function(){
        // Fade out the title
        TweenMax.to(title, 0.75, {alpha:0,
          onComplete: function(){
            app.stage.removeChild(title)
          }})

        // TODO: Add blur filter

      })
      .addIndicators({name: "Text", colorTrigger:"#00ffff", colorStart:"#00ffff"})
      .addTo(scrollController);

      // Create scene #8 (Wreck)
      new ScrollMagic.Scene({
          triggerElement: "#scene-8",
          triggerHook: 0.25
      })
      .on("enter", function(){
        sceneId = 3;
        transitionActive = true;

        // Move the background
        TweenMax.to(sceneSprites[3], 2, {
          ease: Circ.easeOut,
          x: -app.screen.width,
          alpha: 0,
          onComplete: function(){
            console.log("animation complete")
            //parallaxOffset =  sceneSprites[0].height + introVideoSprite.height + sceneSprites[1].height + sceneSprites[2].height
            parallaxOffset =  sceneSprites[0].height + introVideoSprite.height
            transitionActive = false;
            background.filters = [displacementFilter, noiseFilter];
            title = createWreckTitle("Une épave de bateau", "23 novembre 1883")
            title.alpha = 0;
            app.stage.addChild(title)
            title.filters = [displacementTextFilter];
            TweenMax.to(title, 1, {alpha:0.75})
          }
        });
      })
      .addIndicators({name: "Wreck", colorTrigger:"#ffff00", colorStart:"#ffff00"})
      .addTo(scrollController);

      // Create scene #9 (Text)
      new ScrollMagic.Scene({
          triggerElement: "#scene-9",
          triggerHook: 0.75
      })
      .on("enter", function(){
        // Fade out the title
        TweenMax.to(title, 0.75, {alpha:0,
          onComplete: function(){
            app.stage.removeChild(title)
          }})

        // TODO: Add blur filter

      })
      .addIndicators({name: "Text", colorTrigger:"#00ffff", colorStart:"#00ffff"})
      .addTo(scrollController);

      //$('#scene-3').tilt({maxTilt:10})

      $('#map-link').on('click', function(){
        app.stage.addChild(scenes.map)
        $(".map_scene").show();
      })

    </script>
</body>

</html>